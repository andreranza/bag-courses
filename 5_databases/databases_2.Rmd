---
title: "Databases"
author: ["Kirill & Nicolas", "cynkra GmbH"]
date: "March 15, 2022"
output:
  cynkradown::cynkra_slides:
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: true
lang: english
font: frutiger
wide: false
colorlinks: false
logo: true
---

<style type="text/css">
.pull-left {
  margin-top: -25px;
}
.pull-right {
  margin-top: -25px;
}
.remark-code {
    font-size: 14px;
}
.font17 {
    font-size: 17px;
}
.font14 {
    font-size: 14px;
}
</style>


```{r databases-2-1, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, comment = "")

library(tidyverse)
library(DBI)
library(dm)

options(width = 68)

options(pillar.bold = TRUE)
options(cli.num_colors = 256)

fansi::set_knit_hooks(knitr::knit_hooks, c("output", "message", "warning", "error"))
```

```{r databases-2-2, results='hide', message=FALSE, cache = FALSE, include = FALSE}
con_duckdb <- dbConnect(duckdb::duckdb())
con_duckdb
```

```{r databases-2-3, cache = FALSE, include = FALSE}
dm::copy_dm_to(
  con_duckdb,
  dm::dm_pixarfilms(),
  set_key_constraints = FALSE,
  temporary = FALSE
)
```

```{r databases-2-4, cache = FALSE, include = FALSE}
pixar_films <- tbl(con_duckdb, "pixar_films")
pixar_films
```

```{r databases-2-5, cache = FALSE, include = FALSE}
con_sqlite <- DBI::dbConnect(RSQLite::SQLite(), extended_types = TRUE)
dm::copy_dm_to(
  con_sqlite,
  dm::dm_pixarfilms(),
  set_key_constraints = FALSE,
  temporary = FALSE
)
```

```{r databases-2-6, cache = FALSE, include = FALSE}
pixar_films_sqlite <- tbl(con_sqlite, "pixar_films")
pixar_films_sqlite
```

---

# Schedule

Extract ⇨ Transform ⇨ Load ⇨ Consume

.pull-left[
## One table

- Read whole tables
- Let the database do the heavy lifting
- Basic ETL for one table
- Subtle issues to watch out for
]

.pull-right[
## Multiple tables

- **Joins**
- The {dm} package
- A bit of theory
- Playing the whole game
]

## Bonus: Bring your own data + questions

---

background-image: url("images/21.webp")
background-size: 40%
background-position: 100% 100%

# Joins

.pull-left[
- Usage
- Join sources
- Mounting

Script: `databases_21.R`

```{r databases-2-7 }
library(tidyverse)
```
]

---

background-image: url("images/21-frame.webp")
background-size: 40%
background-position: 100% 100%

# Joins

.pull-left[
- Usage
- Join sources
- Mounting

Script: `databases_21.R`

```{r databases-2-8 }
library(tidyverse)
```
]

---

```{r}
# Lazy tables ------------------------------------------------------------------

pixar_films <- tbl(con_duckdb, "pixar_films")
academy <- tbl(con_duckdb, "academy")

pixar_films_sqlite <- tbl(con_sqlite, "pixar_films")
academy_sqlite <- tbl(con_sqlite, "academy")

academy
academy %>%
  count(status)

# Left join ------

academy %>%
  left_join(pixar_films)

academy %>%
  left_join(pixar_films, by = "film")

academy %>%
  left_join(pixar_films, by = "film") %>%
  show_query()

# Join with prior computation ------

academy_won <-
  academy %>%
  filter(status == "Won") %>%
  count(film, name = "n_won")

pixar_films %>%
  left_join(academy_won, by = "film")

pixar_films %>%
  left_join(academy_won, by = "film") %>%
  arrange(release_date)

pixar_films %>%
  left_join(academy_won, by = "film") %>%
  mutate(n_won = coalesce(n_won, 0L)) %>%
  arrange(release_date)

pixar_films %>%
  left_join(academy_won, by = "film") %>%
  mutate(n_won = coalesce(n_won, 0L)) %>%
  arrange(release_date) %>%
  show_query()

# Caveat: tables must be on the same source ------------------------------------

try(
  academy %>%
    left_join(pixar_films_sqlite, by = "film")
)

academy %>%
  left_join(pixar_films_sqlite, by = "film", copy = TRUE)

academy %>%
  left_join(pixar_films_sqlite, by = "film", copy = TRUE) %>%
  show_query()

try(
  pixarfilms::academy %>%
    left_join(pixar_films, by = "film")
)

pixarfilms::academy %>%
  left_join(pixar_films, by = "film", copy = TRUE)

# DuckDB only: register data frames as local tables ----------------------------

# Register data frame as table in DuckDB
duckdb::duckdb_register(
  con_duckdb,
  "academy_small",
  pixarfilms::academy[1:3, ]
)
academy_small <- tbl(con_duckdb, "academy_small")
academy_small
academy_small %>%
  left_join(pixar_films, by = "film")

# Also works for Arrow datasets via duckdb::duckdb_register_arrow()

# ETL, revisited ---------------------------------------------------------------

db_path <- fs::path_abs("pixar.duckdb")
con <- DBI::dbConnect(duckdb::duckdb(dbdir = db_path))
DBI::dbWriteTable(con, "academy", pixarfilms::academy, overwrite = TRUE)
DBI::dbExecute(con, "CREATE UNIQUE INDEX academy_pk ON academy (film, award_type)")
DBI::dbExecute(con, "CREATE INDEX academy_fk ON academy (film)")
DBI::dbDisconnect(con)


# Exercises --------------------------------------------------------------------

pixar_films %>%
  left_join(academy, by = "film")

# 1. How many rows does the join between `academy` and `pixar_films` contain?
#    Try to find out without loading all the data into memory. Explain.
# 2. Which films are not yet listed in the `academy` table? What does the
#    resulting SQL query look like?
#    - Hint: Use `anti_join()`
# 3. Transform `academy` into a wide table so that there is at most one row
#    per film. Join the resulting table with the `pixar_films` table.
#    - Hint: Use `pivot_wider()`, `spread()`, `dcast()`, ... . You need to
#      compute locally, because these functions don't work on the database.
# 4. Plot a bar chart with the number of awards won and nominated per year.
#    Compute as much as possible on the database.
#    - Hint: "Long form" or "wide form"?
```

