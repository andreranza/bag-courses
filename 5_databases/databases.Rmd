---
title: "Databases"
author: ["Kirill & Nicolas", "cynkra GmbH"]
date: "March 15, 2022"
output:
  cynkradown::cynkra_slides:
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
    seal: true
lang: english
font: frutiger
wide: false
colorlinks: false
logo: true
---

<style type="text/css">
.pull-left {
  margin-top: -25px;
}
.pull-right {
  margin-top: -25px;
}
.remark-code {
    font-size: 17px;
}
.font17 {
    font-size: 17px;
}
.font14 {
    font-size: 14px;
}
</style>


```{r databases-0, include = FALSE}
knitr::opts_chunk$set(cache = TRUE)

library(tidyverse)
library(DBI)
library(dm)

options(width = 160)

options(pillar.bold = TRUE)
options(cli.num_colors = 256)

fansi::set_knit_hooks(knitr::knit_hooks, c("output", "message", "warning", "error"))
```


# Introduction

Organization of half-day R courses:

- Intro courses:
  * Tidyverse intro I
  * Base R intro/Tidyverse intro II
  * Data visualization I
  * Data visualization II
- Advanced courses:
  * Advanced tidyverse
  * R package creation
  * Working with database systems
  * Parallelization & efficient R programming
  * Databases (this course)

---

# Course material

Our course material currently is available from GitHub at

https://github.com/cynkra/bag-courses

Today we will be looking at the folder `5_databases`

---

# Download course material

![how to download](cynkra-repo-dl.png)

---

# General remarks

- We hope for these courses to be interactive: go ahead and ask if something is unclear!
- You can also write into the chat, which I will try to monitor when Kirill is presenting.
- We were asked to provide recordings of the courses for those of you who cannot join, so recording is activated.
- Per course unit, we offer 4 hours of follow up time; approach us with questions (nicolas@cynkra.com)!

---

# Goals for today

Playing the whole game!

- Extract
- Transform
- Load
- **Consume**

---

# Schedule

Extract ⇨ Transform ⇨ Load ⇨ Consume

.pull-left[
## One table

- Read whole tables
- Let the database do the heavy lifting
- Subtle issues to watch out for
- Basic ETL for one table
]

.pull-right[
## Multiple tables

- Joins
- The {dm} package
- A bit of theory
- Playing the whole game
]

## Bonus: Bring your own data + questions

---

# Schedule

Extract ⇨ Transform ⇨ Load ⇨ Consume

.pull-left[
## One table

- **Read whole tables**
- Let the database do the heavy lifting
- Subtle issues to watch out for
- Basic ETL for one table
]

.pull-right[
## Multiple tables

- Joins
- The {dm} package
- A bit of theory
- Playing the whole game
]

## Bonus: Bring your own data + questions

---

# Read whole tables

- {DBI} package
- Connect
- Discover
- Read
- Query

Script: `databases_11.R`

```{r databases-1}
library(tidyverse)
library(DBI)
```

---

# Connect to the database

First step when accessing the database.

```{r databases-2, results='hide', message=FALSE}
con_duckdb <- dbConnect(duckdb::duckdb())
con_duckdb
```

```
## <duckdb_connection 0faa0 driver=<duckdb_driver 22170 dbdir=':memory:' read_only=FALSE>>
```

insert: duckdb logo, other database logos

---

insert: major boring shit

---

# Prepare database

Normally done in a preparatory step.

insert: bunny

```{r databases-3}
dm::copy_dm_to(
  con_duckdb,
  dm::dm_pixarfilms(),
  set_key_constraints = FALSE,
  temporary = FALSE
)
```

---

# Discover tables

Where is my data?

```{r databases-4}
dbListTables(con_duckdb)
dbListFields(con_duckdb, "pixar_films")
```

Caveat: schemas, catalogs, ...

```sql
SELECT * FROM INFORMATION_SCHEMA.TABLES
```

---

# Read tables

Read entire tables into your local session, if you can afford it.

```{r databases-5}
df_pixar_films <- dbReadTable(con_duckdb, "pixar_films")
df_pixar_films
```

---

# Read tables

Use `as_tibble()` to convert to a tibble for better display
and more robust operation.

```{r databases-6}
df_pixar_films <- dbReadTable(con_duckdb, "pixar_films")
as_tibble(df_pixar_films)
```

---

# Execute queries

Write SQL code to define what data you want to see.

```{r databases-7}
dbGetQuery(con_duckdb, "SELECT * FROM pixar_films")
```

---

# Execute queries

Write complex SQL code to define what data you want to see.

```{r databases-8}
sql <- "
SELECT * FROM pixar_films
WHERE release_date >= '2020-01-01'
"
```

```{r databases-9}
dbGetQuery(con_duckdb, sql)
```

---

# Execute queries

R 4.0 or later: use new-style string literals for mixing quotes.

```{r databases-10, eval = FALSE}
sql <- r"(
SELECT * FROM "pixar_films"
WHERE "release_date" >= '2020-01-01'
)"
```

```{r databases-11}
dbGetQuery(con_duckdb, sql)
```

---

# Further pointers

insert: bunny

.pull-left[
## Quoting

```{r databases-12}
dbQuoteIdentifier(con_duckdb, "academy")
dbQuoteLiteral(con_duckdb, "Toy Story")
dbQuoteLiteral(con_duckdb, as.Date("2020-01-01"))
```
]

.pull-right[
## Parameterized queries

```{r databases-13}
sql <- "
SELECT count(*) FROM pixar_films
WHERE release_date >= ?
"
dbGetQuery(con_duckdb, sql,
  params = list(as.Date("2020-01-01"))
)
```
]

---

.pull-left[
]

.pull-right[
]
