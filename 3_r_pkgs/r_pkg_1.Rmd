---
title: "R package creation"
author: ["Tobias & Nicolas", "cynkra GmbH"]
date: "February 15, 2022"
output:
  cynkradown::cynkra_slides:
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
    seal: true
fontsize: 10pt
lang: english
font: frutiger
wide: false
colorlinks: false
logo: true
header-includes:
  - \usepackage{parskip}
---

<style type="text/css">
.remark-code {
    font-size: 12px;
}
.font17 {
    font-size: 17px;
}
.font14 {
    font-size: 14px;
}
</style>


```{r echo=FALSE,include=FALSE}
library(tidyverse)
library(kableExtra)
library(knitr)
library(rmarkdown)
```


# Introduction

Organization of half-day R courses:

- Intro courses:
  * Tidyverse intro I
  * Tidyverse intro II
  * Data visualization I
  * Data visualization II
- Advanced courses:
  * Advanced tidyverse
  * R package creation (this course)
  * Working with database systems
  * Parallelization & efficient R programming
  * Advanced topics (tbd)

???

<!-- Antoine and I would like to welcome you on behalf of Cynkra. In the coming weeks we will be organizing two sets or R courses, split up as introductory and advanced. Each course will be half a day and the advanced courses are held twice in succession. Today we're starting with a first tidyverse intro course. -->

---

# Dates

- Week 1, Jan 25: Tidyverse intro I (Antoine)
- Week 2, Feb 1: Tidyverse intro II + Adv. Tidyverse (Antoine)
- Week 3, Feb 8: Adv. Tidyverse (Antoine)
- Week 4, Feb 15: R-pkg creation (Tobias)
- Week 5, Feb 22: R-pkg creation (Tobias), Feb 24: Data vis. & ggplot2 I (Antoine)
- Week 6, Mar 1: Data vis. & ggplot2 II (Antoine) + Parallelization (Patrick)
- Week 7, Mar 8: Parallelization (Patrick)
- Week 8, Mar 15: Databases (Kirill)
- Week 9, Mar 22: Databases (Kirill)
- Week 9, Mar 22: TBD (?)

???
<!-- Courses are typically held on Tuesdays, with the exception of the first intro course on data visualization. Intro courses are in the mornings, while advanced courses take place on afternoons. We initially were hoping to be able to carry out these courses with physical presence, but at least for now, this is not possible. Hopefully, this will change over the course of the next weeks to months. For each course, two people representing Cynkra will be available, a topic-specific expert, as well as myself in a coordinating role. -->

---

# Course material

Our course material currently is available from a Github repository at

https://github.com/cynkra/bag-courses

![how to download](cynkra-repo-dl.png)

???
<!-- If anyone has issues accessing this material, let us know, it's important to us that you have the code available to experiment with. -->

---

# General remarks

<!-- - Even though we are starting out remotely, we hope for these courses to be interactive: go ahead and ask if something is unclear! -->
<!-- - We were asked to provide recordings of the courses for those of you who cannot join, so recording is activated -->
- Per course unit, we offer 4 hours of follow up time; approach us with questions (nicolas@cynkra.com)!

???
<!-- We're not only here to tell you some new and interesting things about R, but we'd also like to help you apply that knowledge to actual scenarios you're dealing with. So in this course follow up time, we're happy to help you with questions you might have regarding course material. But we would like to also offer our help with questions that come up when applying R to your day to day tasks. If you have a question you'd like to discuss, write us an email and we will schedule a meeting. -->

---

# R package creation

Overview:

1. Advantages of R packages over R scripts
1. Advantages of R scripts over R packages
1. How to start?
1. Documentation
1. Useful little helpers: `{usethis}`
1. `{devtools}` (maybe in best practices?)
1. Bring it to github (CRAN not covered here)
1. Classes
1. Methods vs. functions
1. Errors and warnings
1. Best practices
1. Further reading

---

# Advantages of R packages over R scripts

- Best case: Package provides function(s) for working on re-occurring tasks
- function as single source of truth (optimized implementation, higher chance of being bug-free)
- sometimes related tasks can be solved by one function by introducing an argument
- arguments, behavior and result can be well documented (cf. later)
- functions can be tested (cf. later)
- can be shared easily

---

# Advantages of R scripts over R packages

- Package is less flexible (but can be extended)
- Tasks for which script is preferrable: 
    1. "Quickly checking something, but should be reproducible"
    1. Data exploration
    1. Report creation (function to create report could also be part of a package though)

---

# R scripts vs. R packages

Summary:
- R package provides functionality; contains functions (and/or data)
- R script tries solving a certain, rather specific task at hand <-> R packages provide the tools

<!-- # FIXME: some more content? -->

---

# How to start?

In order for RStudio to recognize a project as a package, it needs:
File `DESCRIPTION`, which contains:
- package name as it will be called by e.g. `library()`
- authors, etc.
- dependencies on other packages
- etc.

If this file is there:
- a `Build`-pane is available in RStudio (restart may be necessary)
- the package can be installed to the library

---

# How to start?

Further components:
- File `NAMESPACE` containing information about imported and exported functions
- Directory `R/`, containing the files with the function definitions
- Directory `man/`, containing the `Rd`-files with the documentation of the package's functions

---

# How to start?

There are 2 obvious and easy ways of creating a new valid package in R/RStudio in no time:
1. Using RStudio functionality:  
                `Create a project` -> 
                `New Directory` (or existing empty one) ->  
                `R Package` ->
                fill out mask ->
                `Create package`
2. Using {usethis}: `usethis::create_package("path/to/package")`

.remark-code[Attention: Naming rule for R packages (CRAN rule):
  - only letters (lower- or uppercase), numbers and "." (no "-" or "_")
  - start with a letter
  - can't end with a "."]

---

# Exercise

- Create an R package (or 2) in one of the shown ways.
- Examine the files/directories that were created.

---

# Documentation

Can be found in the `Rd`-files in directory `man/`.

Example:
```{md}
% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hello.R
\name{hello}
\alias{hello}
\title{Title}
\usage{
hello()
}
\value{
Prints "Hello, World!" in green.
}
\description{
Title
}
\examples{
hello()
}
```

---

# Documentation

Use `{roxygen2}` for automating the documentation process as much as possible.

Example:
```{r eval=FALSE}
#' Title
#'
#' @return Prints "Hello, World!" in green.
#' @export
#'
#' @examples
#' hello()
hello <- function() {
  cat(crayon::green("Hello, World!"))
}
```


---

# Documentation

These specially formatted comments will be translated and written to respective `Rd`-file when calling `devtools::document()` or keyboard shortcut `Ctrl+Shift+D`.

An exhaustive intro to documentation can be found here:
- General info and vignettes on: https://roxygen2.r-lib.org/index.html
- Workflow/general best practices: https://r-pkgs.org/man.html

---

# Documentation

The documentation of a function consists of:
.font17[
```{r echo=FALSE,out.width=='70%'}
tibble::tribble(
  ~Field, ~Tag, ~Info,
  "Header", "", "Description in a few words",
  "Description", "@description", "Description in one or two short sentences",
  "Usage", "", "Is added automatically by {roxygen2}/'devtools::document()'",
  "Arguments", "@param/@inheritParams", "Requirements for the arguments",
  "Details", "@details", "Additional useful info for the user",
  "Value", "@return", "What is the output of the function?",
  "...", "...", "Others: see references"
) %>% 
  knitr::kable()
```
]

---

# Documentation

Important: In order to make a function available to users loading the package, there needs to be a tag `@export`.

Usually only exported functions are documented in that detailed manner.

It helps to add commentary to internal functions, too though.

All non-exported (so-called internal) functions are available for all other internal or exported functions of the package.
They are available in the console as well after calling `devtools::load_all()` while working on the package.

---

# Exercise (~10min)

- Make up a function (does not have to be particularly useful) with at least one argument and save its implementation in a file in the directory `R/` of your new package.
- Add documentation to the function (tip: `Code` -> `Insert Roxygen Skeleton` while cursor in the function definition block; or `Ctrl+Alt+Shift+R`, if you manage)
- Make sure the function will be exported
- Make sure the associated `Rd`-file exists and is filled according to your documentation
- "Build" your package using the `Build` pane or `devtools::build()` and use the function

One more tip: in general it can be helpful to "cheat" by checking out how the documentation is done in packages on GitHub that have a documentation feature you would like for your own package.

---

# Useful little helpers: `{usethis}`

We have already encountered a few functions from the package {devtools} (`document()`, `load_all()`, `build()`) that help with package development.

Another package that has this goal is {usethis}.
It is full of helper functions that facilitate package creation. We already encountered `usethis::create_package("")`.

---


# Classes

The only type of classes covered here are S3 classes (by far the most prevalent ones).

.font17[
Resources for learning about S4, e.g.:
- https://stat.ethz.ch/R-manual/R-devel/library/methods/html/Introduction.html
- https://adv-r.hadley.nz/s4.html

Resources for learning about Reference Classes (R5), e.g.:
- https://stat.ethz.ch/R-manual/R-devel/library/methods/html/refClass.html
- https://www.datamentor.io/r-programming/reference-class/
- (http://adv-r.had.co.nz/R5.html)

Resources for learning about R6, e.g.:
- https://r6.r-lib.org/articles/Introduction.html
- https://adv-r.hadley.nz/r6.html
]

---

# S3 Classes

.font17[
Resources for learning (more) about S3, e.g.:
- https://stat.ethz.ch/R-manual/R-devel/library/methods/html/Introduction.html
- https://adv-r.hadley.nz/s3.html
]

The S3 class is one of the 4 (if you include R6) object oriented classes in R.
If the object `x` is NOT of a base type, the S3 class is the answer to the call `class(x)`.

---

# S3 Classes

.font17[
These are examples of base types (do NOT possess an attribute `class` & `is.object(x)` is `FALSE`):

`NULL`, `logical`, `integer`, `double`, `complex`, `character`, `list`, `raw`
]

How to define a new S3 class in a package?

You do not have to explicitly define/export a class.
You set an attribute `class` with the name of the new class, that's all, e.g.:
```{r}
create_new_class <- function(x) {structure(x, class = c("new_class", class(x)))}
class(create_new_class(1))
class(create_new_class("1"))
```


---

S3 Classes

Now we know how to invent a new class.
Why would we want that though?

For example:
- We want to deal with objects which are a certain subset of another class or base type.
- We are dealing with data for which certain rules apply and we want to exploit the associated possibilities.

R example:
```{r}
create_digit <- function(x) {
  if (!is.integer(x) | x < 0 | x > 9) stop("This is not a digit")
  structure(x, class = c("digit", class(x)))
}
```



---

# Methods vs. functions



---

# Errors and warnings

---

# Best practices

- "Functions should do one thing only, but do it well"
<!-- you'll see if your function is too much "all over the place" while documenting its behavior. -->
- But: wrapper functions can of course also be useful
- Comments in the code for others/your future self
- Errors with descriptive messages
- Consider writing a vignette once the pkg takes on shape
- Unit testing with `{testthat}`
- GitHub Actions (e.g. `R CMD check`)


---

# Further reading

- https://r-pkgs.org/index.html
- https://www.pipinghotdata.com/posts/2020-10-25-your-first-r-package-in-1-hour/
- https://cran.r-project.org/doc/manuals/R-exts.html#Creating-R-packages
- Create a website for your package (e.g. on GitHub Pages): https://pkgdown.r-lib.org/index.html

Release to CRAN:

- e.g. https://r-pkgs.org/release.html

---

**Additional material**


---
